import{CLASS_CROP,CLASS_DISABLED,CLASS_HIDDEN,CLASS_MODAL,CLASS_MOVE,DATA_ACTION,DRAG_MODE_CROP,DRAG_MODE_MOVE,DRAG_MODE_NONE,EVENT_ZOOM,NAMESPACE}from"./constants";import{addClass,assign,dispatchEvent,forEach,getAdjustedSizes,getOffset,getPointersCenter,getSourceCanvas,isNumber,isPlainObject,isUndefined,normalizeDecimalNumber,removeClass,setData,toggleClass}from"./utilities";export default{crop(){return!this.ready||this.cropped||this.disabled||(this.cropped=!0,this.limitCropBox(!0,!0),this.options.modal&&addClass(this.dragBox,CLASS_MODAL),removeClass(this.cropBox,CLASS_HIDDEN),this.setCropBoxData(this.initialCropBoxData)),this},reset(){return this.ready&&!this.disabled&&(this.imageData=assign({},this.initialImageData),this.canvasData=assign({},this.initialCanvasData),this.cropBoxData=assign({},this.initialCropBoxData),this.renderCanvas(),this.cropped&&this.renderCropBox()),this},clear(){return this.cropped&&!this.disabled&&(assign(this.cropBoxData,{left:0,top:0,width:0,height:0}),this.cropped=!1,this.renderCropBox(),this.limitCanvas(!0,!0),this.renderCanvas(),removeClass(this.dragBox,CLASS_MODAL),addClass(this.cropBox,CLASS_HIDDEN)),this},replace(t,e=!1){return!this.disabled&&t&&(this.isImg&&(this.element.src=t),e?(this.url=t,this.image.src=t,this.ready&&(this.viewBoxImage.src=t,forEach(this.previews,e=>{e.getElementsByTagName("img")[0].src=t}))):(this.isImg&&(this.replaced=!0),this.options.data=null,this.uncreate(),this.load(t))),this},enable(){return this.ready&&this.disabled&&(this.disabled=!1,removeClass(this.cropper,CLASS_DISABLED)),this},disable(){return this.ready&&!this.disabled&&(this.disabled=!0,addClass(this.cropper,CLASS_DISABLED)),this},destroy(){const{element:t}=this;return t[NAMESPACE]?(t[NAMESPACE]=undefined,this.isImg&&this.replaced&&(t.src=this.originalUrl),this.uncreate(),this):this},move(t,e=t){const{left:i,top:a}=this.canvasData;return this.moveTo(isUndefined(t)?t:i+Number(t),isUndefined(e)?e:a+Number(e))},moveTo(t,e=t){const{canvasData:i}=this;let a=!1;return t=Number(t),e=Number(e),this.ready&&!this.disabled&&this.options.movable&&(isNumber(t)&&(i.left=t,a=!0),isNumber(e)&&(i.top=e,a=!0),a&&this.renderCanvas(!0)),this},zoom(t,e){const{canvasData:i}=this;return t=(t=Number(t))<0?1/(1-t):1+t,this.zoomTo(i.width*t/i.naturalWidth,null,e)},zoomTo(t,e,i){const{options:a,canvasData:s}=this,{width:h,height:r,naturalWidth:o,naturalHeight:n}=s;if((t=Number(t))>=0&&this.ready&&!this.disabled&&a.zoomable){const a=o*t,d=n*t;if(!1===dispatchEvent(this.element,EVENT_ZOOM,{ratio:t,oldRatio:h/o,originalEvent:i}))return this;if(i){const{pointers:t}=this,e=getOffset(this.cropper),o=t&&Object.keys(t).length?getPointersCenter(t):{pageX:i.pageX,pageY:i.pageY};s.left-=(a-h)*((o.pageX-e.left-s.left)/h),s.top-=(d-r)*((o.pageY-e.top-s.top)/r)}else isPlainObject(e)&&isNumber(e.x)&&isNumber(e.y)?(s.left-=(a-h)*((e.x-s.left)/h),s.top-=(d-r)*((e.y-s.top)/r)):(s.left-=(a-h)/2,s.top-=(d-r)/2);s.width=a,s.height=d,this.renderCanvas(!0)}return this},rotate(t){return this.rotateTo((this.imageData.rotate||0)+Number(t))},rotateTo(t){return t=Number(t),isNumber(t)&&this.ready&&!this.disabled&&this.options.rotatable&&(this.imageData.rotate=t%360,this.renderCanvas(!0,!0)),this},scaleX(t){const{scaleY:e}=this.imageData;return this.scale(t,isNumber(e)?e:1)},scaleY(t){const{scaleX:e}=this.imageData;return this.scale(isNumber(e)?e:1,t)},scale(t,e=t){const{imageData:i}=this;let a=!1;return t=Number(t),e=Number(e),this.ready&&!this.disabled&&this.options.scalable&&(isNumber(t)&&(i.scaleX=t,a=!0),isNumber(e)&&(i.scaleY=e,a=!0),a&&this.renderCanvas(!0,!0)),this},getData(t=!1){const{options:e,imageData:i,canvasData:a,cropBoxData:s}=this;let h;if(this.ready&&this.cropped){h={x:s.left-a.left,y:s.top-a.top,width:s.width,height:s.height};const e=i.width/i.naturalWidth;if(forEach(h,(t,i)=>{h[i]=t/e}),t){const t=Math.round(h.y+h.height),e=Math.round(h.x+h.width);h.x=Math.round(h.x),h.y=Math.round(h.y),h.width=e-h.x,h.height=t-h.y}}else h={x:0,y:0,width:0,height:0};return e.rotatable&&(h.rotate=i.rotate||0),e.scalable&&(h.scaleX=i.scaleX||1,h.scaleY=i.scaleY||1),h},setData(t){const{options:e,imageData:i,canvasData:a}=this,s={};if(this.ready&&!this.disabled&&isPlainObject(t)){let h=!1;e.rotatable&&isNumber(t.rotate)&&t.rotate!==i.rotate&&(i.rotate=t.rotate,h=!0),e.scalable&&(isNumber(t.scaleX)&&t.scaleX!==i.scaleX&&(i.scaleX=t.scaleX,h=!0),isNumber(t.scaleY)&&t.scaleY!==i.scaleY&&(i.scaleY=t.scaleY,h=!0)),h&&this.renderCanvas(!0,!0);const r=i.width/i.naturalWidth;isNumber(t.x)&&(s.left=t.x*r+a.left),isNumber(t.y)&&(s.top=t.y*r+a.top),isNumber(t.width)&&(s.width=t.width*r),isNumber(t.height)&&(s.height=t.height*r),this.setCropBoxData(s)}return this},getContainerData(){return this.ready?assign({},this.containerData):{}},getImageData(){return this.sized?assign({},this.imageData):{}},getCanvasData(){const{canvasData:t}=this,e={};return this.ready&&forEach(["left","top","width","height","naturalWidth","naturalHeight"],i=>{e[i]=t[i]}),e},setCanvasData(t){const{canvasData:e}=this,{aspectRatio:i}=e;return this.ready&&!this.disabled&&isPlainObject(t)&&(isNumber(t.left)&&(e.left=t.left),isNumber(t.top)&&(e.top=t.top),isNumber(t.width)?(e.width=t.width,e.height=t.width/i):isNumber(t.height)&&(e.height=t.height,e.width=t.height*i),this.renderCanvas(!0)),this},getCropBoxData(){const{cropBoxData:t}=this;let e;return this.ready&&this.cropped&&(e={left:t.left,top:t.top,width:t.width,height:t.height}),e||{}},setCropBoxData(t){const{cropBoxData:e}=this,{aspectRatio:i}=this.options;let a,s;return this.ready&&this.cropped&&!this.disabled&&isPlainObject(t)&&(isNumber(t.left)&&(e.left=t.left),isNumber(t.top)&&(e.top=t.top),isNumber(t.width)&&t.width!==e.width&&(a=!0,e.width=t.width),isNumber(t.height)&&t.height!==e.height&&(s=!0,e.height=t.height),i&&(a?e.height=e.width/i:s&&(e.width=e.height*i)),this.renderCropBox()),this},getCroppedCanvas(t={}){if(!this.ready||!window.HTMLCanvasElement)return null;const{canvasData:e}=this,i=getSourceCanvas(this.image,this.imageData,e,t);if(!this.cropped)return i;let{x:a,y:s,width:h,height:r}=this.getData();const o=i.width/Math.floor(e.naturalWidth);1!==o&&(a*=o,s*=o,h*=o,r*=o);const n=h/r,d=getAdjustedSizes({aspectRatio:n,width:t.maxWidth||Infinity,height:t.maxHeight||Infinity}),l=getAdjustedSizes({aspectRatio:n,width:t.minWidth||0,height:t.minHeight||0},"cover");let{width:c,height:g}=getAdjustedSizes({aspectRatio:n,width:t.width||(1!==o?i.width:h),height:t.height||(1!==o?i.height:r)});c=Math.min(d.width,Math.max(l.width,c)),g=Math.min(d.height,Math.max(l.height,g));const m=document.createElement("canvas"),p=m.getContext("2d");m.width=normalizeDecimalNumber(c),m.height=normalizeDecimalNumber(g),p.fillStyle=t.fillColor||"transparent",p.fillRect(0,0,c,g);const{imageSmoothingEnabled:u=!0,imageSmoothingQuality:D}=t;p.imageSmoothingEnabled=u,D&&(p.imageSmoothingQuality=D);const b=i.width,C=i.height;let N,f,A,S,w,v,x=a,E=s;x<=-h||x>b?(x=0,N=0,A=0,w=0):x<=0?(A=-x,x=0,w=N=Math.min(b,h+x)):x<=b&&(A=0,w=N=Math.min(h,b-x)),N<=0||E<=-r||E>C?(E=0,f=0,S=0,v=0):E<=0?(S=-E,E=0,v=f=Math.min(C,r+E)):E<=C&&(S=0,v=f=Math.min(r,C-E));const y=[x,E,N,f];if(w>0&&v>0){const t=c/h;y.push(A*t,S*t,w*t,v*t)}return p.drawImage(i,...y.map(t=>Math.floor(normalizeDecimalNumber(t)))),m},setAspectRatio(t){const{options:e}=this;return this.disabled||isUndefined(t)||(e.aspectRatio=Math.max(0,t)||NaN,this.ready&&(this.initCropBox(),this.cropped&&this.renderCropBox())),this},setDragMode(t){const{options:e,dragBox:i,face:a}=this;if(this.ready&&!this.disabled){const s=t===DRAG_MODE_CROP,h=e.movable&&t===DRAG_MODE_MOVE;t=s||h?t:DRAG_MODE_NONE,e.dragMode=t,setData(i,DATA_ACTION,t),toggleClass(i,CLASS_CROP,s),toggleClass(i,CLASS_MOVE,h),e.cropBoxMovable||(setData(a,DATA_ACTION,t),toggleClass(a,CLASS_CROP,s),toggleClass(a,CLASS_MOVE,h))}return this}};