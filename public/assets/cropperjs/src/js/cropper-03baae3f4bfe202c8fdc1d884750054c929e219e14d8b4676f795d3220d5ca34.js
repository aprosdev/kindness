import DEFAULTS from"./defaults";import TEMPLATE from"./template";import render from"./render";import preview from"./preview";import events from"./events";import handlers from"./handlers";import change from"./change";import methods from"./methods";import{ACTION_ALL,CLASS_HIDDEN,CLASS_HIDE,CLASS_INVISIBLE,CLASS_MOVE,DATA_ACTION,EVENT_READY,MIME_TYPE_JPEG,NAMESPACE,REGEXP_DATA_URL_JPEG,REGEXP_TAG_NAME,WINDOW}from"./constants";import{addClass,addListener,addTimestamp,arrayBufferToDataURL,assign,dataURLToArrayBuffer,dispatchEvent,isCrossOriginURL,isFunction,isPlainObject,parseOrientation,removeClass,resetAndGetOrientation,setData}from"./utilities";const AnotherCropper=WINDOW.Cropper;class Cropper{constructor(e,t={}){if(!e||!REGEXP_TAG_NAME.test(e.tagName))throw new Error("The first argument is required and must be an <img> or <canvas> element.");this.element=e,this.options=assign({},DEFAULTS,isPlainObject(t)&&t),this.cropped=!1,this.disabled=!1,this.pointers={},this.ready=!1,this.reloading=!1,this.replaced=!1,this.sized=!1,this.sizing=!1,this.init()}init(){const{element:e}=this,t=e.tagName.toLowerCase();let i;if(!e[NAMESPACE]){if(e[NAMESPACE]=this,"img"===t){if(this.isImg=!0,i=e.getAttribute("src")||"",this.originalUrl=i,!i)return;i=e.src}else"canvas"===t&&window.HTMLCanvasElement&&(i=e.toDataURL());this.load(i)}}load(e){if(!e)return;this.url=e,this.imageData={};const{element:t,options:i}=this;if(i.rotatable||i.scalable||(i.checkOrientation=!1),!i.checkOrientation||!window.ArrayBuffer)return void this.clone();if(REGEXP_DATA_URL_JPEG.test(e))return void this.read(dataURLToArrayBuffer(e));const s=new XMLHttpRequest,r=this.clone.bind(this);this.reloading=!0,this.xhr=s,s.onabort=r,s.onerror=r,s.ontimeout=r,s.onprogress=(()=>{s.getResponseHeader("content-type")!==MIME_TYPE_JPEG&&s.abort()}),s.onload=(()=>{this.read(s.response)}),s.onloadend=(()=>{this.reloading=!1,this.xhr=null}),i.checkCrossOrigin&&isCrossOriginURL(e)&&t.crossOrigin&&(e=addTimestamp(e)),s.open("GET",e),s.responseType="arraybuffer",s.withCredentials="use-credentials"===t.crossOrigin,s.send()}read(e){const{options:t,imageData:i}=this,s=resetAndGetOrientation(e);let r=0,a=1,n=1;s>1&&(this.url=arrayBufferToDataURL(e,MIME_TYPE_JPEG),({rotate:r,scaleX:a,scaleY:n}=parseOrientation(s))),t.rotatable&&(i.rotate=r),t.scalable&&(i.scaleX=a,i.scaleY=n),this.clone()}clone(){const{element:e,url:t}=this;let i,s;this.options.checkCrossOrigin&&isCrossOriginURL(t)&&(({crossOrigin:i}=e),i?s=t:(i="anonymous",s=addTimestamp(t))),this.crossOrigin=i,this.crossOriginUrl=s;const r=document.createElement("img");i&&(r.crossOrigin=i),r.src=s||t,this.image=r,r.onload=this.start.bind(this),r.onerror=this.stop.bind(this),addClass(r,CLASS_HIDE),e.parentNode.insertBefore(r,e.nextSibling)}start(){const e=this.isImg?this.element:this.image;e.onload=null,e.onerror=null,this.sizing=!0;const t=WINDOW.navigator&&/^(?:.(?!chrome|android))*safari/i.test(WINDOW.navigator.userAgent),i=(e,t)=>{assign(this.imageData,{naturalWidth:e,naturalHeight:t,aspectRatio:e/t}),this.sizing=!1,this.sized=!0,this.build()};if(e.naturalWidth&&!t)return void i(e.naturalWidth,e.naturalHeight);const s=document.createElement("img"),r=document.body||document.documentElement;this.sizingImage=s,s.onload=(()=>{i(s.width,s.height),t||r.removeChild(s)}),s.src=e.src,t||(s.style.cssText="left:0;max-height:none!important;max-width:none!important;min-height:0!important;min-width:0!important;opacity:0;position:absolute;top:0;z-index:-1;",r.appendChild(s))}stop(){const{image:e}=this;e.onload=null,e.onerror=null,e.parentNode.removeChild(e),this.image=null}build(){if(!this.sized||this.ready)return;const{element:e,options:t,image:i}=this,s=e.parentNode,r=document.createElement("div");r.innerHTML=TEMPLATE;const a=r.querySelector(`.${NAMESPACE}-container`),n=a.querySelector(`.${NAMESPACE}-canvas`),o=a.querySelector(`.${NAMESPACE}-drag-box`),d=a.querySelector(`.${NAMESPACE}-crop-box`),h=d.querySelector(`.${NAMESPACE}-face`);this.container=s,this.cropper=a,this.canvas=n,this.dragBox=o,this.cropBox=d,this.viewBox=a.querySelector(`.${NAMESPACE}-view-box`),this.face=h,n.appendChild(i),addClass(e,CLASS_HIDDEN),s.insertBefore(a,e.nextSibling),this.isImg||removeClass(i,CLASS_HIDE),this.initPreview(),this.bind(),t.initialAspectRatio=Math.max(0,t.initialAspectRatio)||NaN,t.aspectRatio=Math.max(0,t.aspectRatio)||NaN,t.viewMode=Math.max(0,Math.min(3,Math.round(t.viewMode)))||0,addClass(d,CLASS_HIDDEN),t.guides||addClass(d.getElementsByClassName(`${NAMESPACE}-dashed`),CLASS_HIDDEN),t.center||addClass(d.getElementsByClassName(`${NAMESPACE}-center`),CLASS_HIDDEN),t.background&&addClass(a,`${NAMESPACE}-bg`),t.highlight||addClass(h,CLASS_INVISIBLE),t.cropBoxMovable&&(addClass(h,CLASS_MOVE),setData(h,DATA_ACTION,ACTION_ALL)),t.cropBoxResizable||(addClass(d.getElementsByClassName(`${NAMESPACE}-line`),CLASS_HIDDEN),addClass(d.getElementsByClassName(`${NAMESPACE}-point`),CLASS_HIDDEN)),this.render(),this.ready=!0,this.setDragMode(t.dragMode),t.autoCrop&&this.crop(),this.setData(t.data),isFunction(t.ready)&&addListener(e,EVENT_READY,t.ready,{once:!0}),dispatchEvent(e,EVENT_READY)}unbuild(){this.ready&&(this.ready=!1,this.unbind(),this.resetPreview(),this.cropper.parentNode.removeChild(this.cropper),removeClass(this.element,CLASS_HIDDEN))}uncreate(){this.ready?(this.unbuild(),this.ready=!1,this.cropped=!1):this.sizing?(this.sizingImage.onload=null,this.sizing=!1,this.sized=!1):this.reloading?(this.xhr.onabort=null,this.xhr.abort()):this.image&&this.stop()}static noConflict(){return window.Cropper=AnotherCropper,Cropper}static setDefaults(e){assign(DEFAULTS,isPlainObject(e)&&e)}}assign(Cropper.prototype,render,preview,events,handlers,change,methods);export default Cropper;